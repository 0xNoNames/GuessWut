"use strict";

$(document).ready(() => {
    $('#back_button').click(() => {
        location.href = '/';
    });

    $('#upload_text').change(() => {
        if ($('#upload_text').val() != '') $('#upload_text').css('background-color', '#90ee90');
        else $('#upload_text').css('background-color', 'white');
        if ($('#upload_text').val() != '' && $('#upload_file').val() != "") $('#upload_button').css('background-color', '#90ee90')
        else $('#upload_button').css('background-color', '#cd5b5b');
    });

    $('#upload_file').change(() => {
        if ($('#upload_file').val() != "") {
            var input = document.getElementById("upload_file");
            var fReader = new FileReader();
            fReader.readAsDataURL(input.files[0]);
            fReader.onloadend = function (event) {
                $('#upload_label').unbind('mouseenter').unbind('mouseleave').html("OK").css({
                    'background-image': "url(" + event.target.result + ")",
                    "color": "#90ee90"
                });
            }
        } else $('#upload_label').html("Choisir un fichier").hover((event) => mousein(), (event) => mouseout());
        if ($('#upload_text').val() != '' && $('#upload_file').val() != "") $('#upload_button').css('background-color', '#90ee90');
        else $('#upload_button').css('background-color', '#cd5b5b');
    });

    function mousein() {
        $('#upload_label').css({
            "color": "white",
            "background-image": "url('/assets/favicon/favicon-256x256.png')",
            "background-position": "center",
            "background-repeat": "no-repeat",
            "background-size": "cover"
        })
    }

    function mouseout() {
        $('#upload_label').css({
            "color": "black",
            "background-image": "none"
        })
    }

    $("#upload_label").hover((event) => mousein(), (event) => mouseout());

    $('#upload_label').click(function () {
        $('#upload_file').click();
    });

    $('#upload_button').click(function (event) {
        event.preventDefault()
        var form = $('#upload_form')[0];
        var data = new FormData(form);
        $.ajax({
            type: "post",
            enctype: 'multipart/form-data',
            url: "upload",
            data: data,
            processData: false,
            contentType: false,
            cache: false,
            success: (data) => {
                if (data.success) {
                    var source = "assets/stonks.mp3"
                    var audio = document.createElement("audio");
                    audio.autoplay = true;
                    audio.load()
                    audio.addEventListener("load", function () {
                        audio.play();
                    }, true);
                    audio.src = source;
                    audio.volume = 0.05;
                    $('#upload_text').val('').css('background-color', 'white');
                    mouseout();
                    $('#upload_label').html("Choisir un fichier").hover((event) => mousein(), (event) => mouseout());
                    $('#upload_button').css('background-color', '#cd5b5b');
                }
                $("#upload_msg").text(data.msg_add);
            },
            error: (e) => {
                $("#upload_msg").text(e.responseText);
            }
        });
    })
})