"use strict";

$(function () {
    var socket = io();
    var chat_color = 0;

    socket.on('username_msg', (socket_msg) => {
        $('#username_msg').show().html(socket_msg);
    });

    socket.on('game_msg', (socket_msg) => {
        let game_json = JSON.parse(socket_msg);
        if (game_json.win) $('#game_msg').html(game_json.message).css("color", "#00ff00");
        else $('#game_msg').html(game_json.message).css("color", "#ff0000");
    });

    socket.on('image', (socket_img) => {
        $('#game_image').attr("src", socket_img);
    });

    socket.on('ready', () => {
        $('#username_div').remove();
        $('body').prepend('<div id="game_msg"></div><div id="score_div"></div><img id="game_image"/><div id="chat_div"></div><div id="guess_div"><form id="guess_form" action=""><input id="guess_input" autocomplete="off" placeholder="Essayez un mot..." /></form></div>');
        $('#guess_input').focus();
        $('#guess_form').submit(function (e) {
            e.preventDefault();
            let message = $('#guess_input').val();
            if (message.trim() && message) {
                socket.emit('guess', $('#guess_input').val());
            }
            $('#guess_input').val('');
        });
    });

    socket.on('update', (socket_msg) => {
        var score_array = JSON.parse(socket_msg);
        score_array.sort(function (a, b) {
            return b[1] - a[1];
        });
        $('#score_div').html('');
        for (let i = 0; i < score_array.length; i++) {
            $('#score_div').append('<ul style="background-color : rgba(0, 0, 0, .5)"><span style="color : ' + score_array[i][1][1] + ';">' + score_array[i][0] + '</span><span>' +
                score_array[i][1][0] + '</span></ul>');
        }
    });

    socket.on('chat', (socket_chat) => {
        let chat_json = JSON.parse(socket_chat);

        if (chat_json.win) {
            if (chat_json.me) {
                $('#chat_div').append('<div id="chat_user_win"><span style="color : ' + chat_json.color + ';">' + chat_json.user + '</span> (' + chat_json.time + 's): ' + chat_json.chat_msg + '</div>');
            } else {
                $('#chat_div').append('<div class="chat_win"><span style="color : ' + chat_json.color + ';">' + chat_json.user + '</span> (' + chat_json.time + 's): ' + chat_json.chat_msg + '</div>');
            }
        } else if (chat_color) {
            if (chat_json.me) {
                $('#chat_div').append('<div class="chat_grey"><span style="color : ' + chat_json.color + ';">' + chat_json.user + '</span> (' + chat_json.time + 's): ' + chat_json.chat_msg + '</div>');
            } else {
                $('#chat_div').append('<div class="chat_grey"><span style="color : ' + chat_json.color + ';">' + chat_json.user + '</span> (' + chat_json.time + 's): ' + chat_json.chat_msg + '</div>');
            }
            chat_color = !chat_color;
        } else {
            if (chat_json.me) {
                $('#chat_div').append('<div class="chat_black"><span style="color : ' + chat_json.color + ';">' + chat_json.user + '</span> (' + chat_json.time + 's): ' + chat_json.chat_msg + '</div>');
            } else {
                $('#chat_div').append('<div class="chat_black"><span style="color : ' + chat_json.color + ';">' + chat_json.user + '</span> (' + chat_json.time + 's): ' + chat_json.chat_msg + '</div>');
            }
            chat_color = !chat_color;
        }
        $('#chat_div').animate({
            scrollTop: $('#chat_div').prop('scrollHeight')
        }, 0);
    });

    socket.on('refresh', () => {
        location.reload();
    });

    $('#username_form').submit(function (e) {
        e.preventDefault();
        if ($('#username_input').val() != '' && $('#username_input').val()) socket.emit('username', $('#username_input').val());
    });
});